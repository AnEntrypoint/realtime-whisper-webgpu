===============================================================================
STATE SHAPE DISCOVERY - FIX FOR state_4
===============================================================================

PROBLEM IDENTIFIED:
- state_4 was incorrectly set to [] (rank 0, scalar)
- Error: "Invalid rank for input: state_4 Got: 0 Expected: 1"
- This clearly indicates rank 0 was provided but rank 1 was expected

SOLUTION APPLIED:
- Changed state_4 from [] to [1] in /mnt/c/dev/realtime-whisper-webgpu/tts/tts-client.js
- Also changed state_5 from [] to [1] as it likely has the same shape

KEY INSIGHT - Understanding ONNX Error Messages:
================================================================================

When ONNX complains about input shapes, there are different types of errors:

1. RANK ERROR (number of dimensions):
   Message: "Invalid rank for input: state_X Got: Y Expected: Z"
   What it means: You provided Y dimensions, but Z dimensions are needed
   Example: "Got: 0 Expected: 1" means you gave [] but need [something]
   
2. DIMENSION VALUE ERROR (size of a dimension):
   Message: "dimensions index: 0 Got: 1 Expected: 0"
   What it means: First dimension has value 1, but should have value 0
   Example: Change shape from [1] to [0]

3. TYPE ERROR (dtype mismatch):
   Message: "expected: (tensor(int64))"
   What it means: This input must be int64, not float32
   Example: Add state to int64States set

CHANGES MADE:
================================================================================

File: /mnt/c/dev/realtime-whisper-webgpu/tts/tts-client.js

Line 226: Updated comment
FROM: "// Pattern: state_0, state_3 are rank 5; state_1 is empty; state_2 is rank 1; state_4-17 are scalars (rank 0)"
TO:   "// Pattern: state_0, state_3 are rank 5; state_1 is empty; state_2, state_4-5 are rank 1; state_6-17 TBD"

Line 232: Updated state shapes
FROM: 'state_4': [], 'state_5': [],     // Rank 0 scalars
TO:   'state_4': [1], 'state_5': [1],     // Rank 1 scalars

CURRENT STATE SHAPE CONFIGURATION:
================================================================================

state_0:  [2, 1, 1000, 16, 64]  - Rank 5, transformer state
state_1:  [0]                   - Rank 0, empty tensor (0 elements)
state_2:  [1]                   - Rank 1, int64 dtype (special)
state_3:  [2, 1, 1000, 16, 64]  - Rank 5, transformer state
state_4:  [1]                   - Rank 1, FIXED - was incorrectly rank 0
state_5:  [1]                   - Rank 1, same as state_4 (untested)
state_6:  []                    - Rank 0 (not yet tested)
state_7:  []                    - Rank 0 (not yet tested)
state_8:  []                    - Rank 0 (not yet tested)
state_9:  []                    - Rank 0 (not yet tested)
state_10: []                    - Rank 0 (not yet tested)
state_11: []                    - Rank 0 (not yet tested)
state_12: []                    - Rank 0 (not yet tested)
state_13: []                    - Rank 0 (not yet tested)
state_14: []                    - Rank 0 (not yet tested)
state_15: []                    - Rank 0 (not yet tested)
state_16: []                    - Rank 0 (not yet tested)
state_17: []                    - Rank 0 (not yet tested)

TESTING STRATEGY:
================================================================================

After this fix, test in this order:

1. IMMEDIATE: Run test-states-systematic.html to verify state_4 works
   - If SUCCESS: state_4=[1] is correct, move to state_5-17
   - If FAIL: Read error, apply fix, test again

2. FOR EACH REMAINING STATE (state_5 through state_17):
   a. Try to run model with current shape
   b. If error, parse the error message
   c. Apply fix based on error type
   d. Retest

3. ERROR TYPE MAPPING:
   - "Invalid rank ... Expected: 0" → change to []
   - "Invalid rank ... Expected: 1" → change to [1]
   - "Invalid rank ... Expected: 5" → change to [2, 1, 1000, 16, 64]
   - "Got: X Expected: Y" → change dimension value from X to Y
   - "expected: (tensor(int64))" → add to int64States set

CREATED TEST FILES:
================================================================================

1. test-state-4-rank1.html
   - Quick test focusing on state_4=[1]
   - Use this to verify the immediate fix

2. test-states-systematic.html
   - Comprehensive test for all 18 states
   - Will try current configuration and show which state fails next
   - Provides clear error message parsing

3. STATE_SHAPE_FIX.md
   - Documentation of the fix

4. TESTING_INSTRUCTIONS.md
   - How to test and interpret results

NEXT ACTIONS:
================================================================================

1. Open test-states-systematic.html in browser
2. Review the error (if any) for the next state
3. Apply fix based on error type interpretation
4. Repeat until all 18 states work correctly

The key is to LISTEN TO THE ERROR MESSAGES - they clearly indicate what's wrong:
- Rank errors tell you the number of dimensions
- Dimension value errors tell you the specific dimension value
- Type errors tell you to change dtype

DO NOT GUESS - let the errors guide you to the solution.

===============================================================================
