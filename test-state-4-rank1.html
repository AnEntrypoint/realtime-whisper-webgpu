<!DOCTYPE html>
<html>
<head>
    <title>Test state_4 with rank 1 ([1])</title>
</head>
<body>
    <h1>Testing state_4 with [1] (rank 1)</h1>
    <pre id="output" style="font-size: 12px; font-family: monospace; max-height: 800px; overflow-y: auto;"></pre>
    <script type="module">
        const ORT_VERSION = '1.20.0';
        const ORT_CDN = ;
        const output = document.getElementById('output');

        function log(msg) {
            console.log(msg);
            output.textContent += msg + '\n';
            output.scrollTop = output.scrollHeight;
        }

        async function test() {
            try {
                log('=== TESTING state_4 with rank 1 ([1]) ===\n');

                const ortModule = await import(ORT_CDN + 'ort.min.mjs');
                const ort = ortModule.default || ortModule;

                ort.env.wasm.wasmPaths = ORT_CDN;
                ort.env.wasm.simd = true;
                ort.env.wasm.numThreads = 1;

                log('Creating session...');
                const session = await ort.InferenceSession.create('/models/tts/flow_lm_main_int8.onnx', {
                    executionProviders: ['wasm'],
                    graphOptimizationLevel: 'all'
                });

                log('Session created\n');

                // Test shapes with state_4 as [1]
                const shapes = {
                    'state_0': [2, 1, 1000, 16, 64],
                    'state_1': [0],
                    'state_2': [1],
                    'state_3': [2, 1, 1000, 16, 64],
                    'state_4': [1],  // RANK 1 - the fix
                    'state_5': [1],
                    'state_6': [1],
                    'state_7': [1],
                    'state_8': [1],
                    'state_9': [1],
                    'state_10': [1],
                    'state_11': [1],
                    'state_12': [1],
                    'state_13': [1],
                    'state_14': [1],
                    'state_15': [1],
                    'state_16': [1],
                    'state_17': [1]
                };

                const dtypes = { 'state_2': 'int64' };
                for (let i = 0; i <= 17; i++) {
                    if (i !== 2) dtypes[] = 'float32';
                }

                log('Creating input tensors...');

                const seqData = new Float32Array(1 * 1 * 32).fill(0);
                const sequence = new ort.Tensor('float32', seqData, [1, 1, 32]);

                const textData = new Float32Array(0);
                const textEmb = new ort.Tensor('float32', textData, [1, 0, 1024]);

                const stateInputs = {};

                for (let i = 0; i <= 17; i++) {
                    const name = ;
                    const shape = shapes[name];
                    const dtype = dtypes[name];
                    const size = shape.reduce((a, b) => a * b, 1);

                    if (size === 0) {
                        stateInputs[name] = new ort.Tensor(dtype, new (dtype === 'int64' ? BigInt64Array : Float32Array)(0), shape);
                    } else {
                        if (dtype === 'int64') {
                            stateInputs[name] = new ort.Tensor('int64', new BigInt64Array(size).fill(BigInt(0)), shape);
                        } else {
                            stateInputs[name] = new ort.Tensor('float32', new Float32Array(size).fill(0), shape);
                        }
                    }
                }

                log('Running model with state_4=[1]...\n');

                const inputs = {
                    sequence,
                    text_embeddings: textEmb,
                    ...stateInputs
                };

                const result = await session.run(inputs);

                log('âœ“ SUCCESS! Model ran successfully with state_4=[1]');
                log('\nOutput keys:');
                for (const key of Object.keys(result)) {
                    const tensor = result[key];
                    log();
                }

                log('\n=== NEXT STEP ===');
                log('state_4 works with rank 1 ([1])');
                log('Now test state_5-17 to determine their ranks');
                log('Use error messages to guide fixes:');
                log('  - "Invalid rank ... Got: 0 Expected: N" = increase rank to N');
                log('  - "Got: X Expected: Y" = change dimension value from X to Y');

            } catch (err) {
                log();
                log('\nThis error tells us what state_4 should be:');
                log('  - "Invalid rank for input: state_4 Got: 1 Expected: 0" = use []');
                log('  - "Invalid rank for input: state_4 Got: 0 Expected: 1" = use [1]');
                log('  - "dimensions index: 0 Got: 1 Expected: 0" = change [1] to [0]');
            }
        }

        test();
    </script>
</body>
</html>
