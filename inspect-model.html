<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ONNX Model Inspector</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
        }
        h1 { color: #333; }
        h2 { color: #666; margin-top: 30px; }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-left: 4px solid #0066cc;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.loading { background: #fff3cd; }
        .status.success { background: #d4edda; }
        .status.error { background: #f8d7da; }
        pre {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .input-row, .output-row {
            padding: 10px;
            margin: 5px 0;
            background: #f9f9f9;
            border-left: 3px solid #0066cc;
        }
        .output-row { border-left-color: #28a745; }
        .state-input { border-left-color: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ONNX Model Inspector</h1>
        <p>This tool inspects the flow_lm_main_int8.onnx model to discover the actual shapes of all state inputs.</p>

        <div class="section">
            <h2>Status</h2>
            <div id="status" class="status loading">Loading ONNX Runtime...</div>
        </div>

        <div class="section">
            <h2>Model Information</h2>
            <div id="model-info"></div>
        </div>

        <div class="section">
            <h2>Input Shapes</h2>
            <div id="inputs"></div>
        </div>

        <div class="section">
            <h2>Output Shapes</h2>
            <div id="outputs"></div>
        </div>

        <div class="section">
            <h2>State Inputs (Critical for TTS)</h2>
            <div id="state-inputs"></div>
        </div>

        <div class="section">
            <h2>Generated Code</h2>
            <p>Copy this code to fix the TTS state initialization:</p>
            <pre id="generated-code"></pre>
        </div>
    </div>

    <script type="module">
        const ORT_VERSION = '1.20.0';
        const ORT_CDN = `https://cdn.jsdelivr.net/npm/onnxruntime-web@${ORT_VERSION}/dist/`;

        async function inspectModel() {
            try {
                updateStatus('Loading ONNX Runtime...', 'loading');

                // Dynamic import to handle module loading
                const ortScriptPath = ORT_CDN + 'ort.min.mjs';
                console.log('Loading from:', ortScriptPath);

                const ortModule = await import(ortScriptPath);
                const ort = ortModule.default || ortModule;

                console.log('ONNX Runtime loaded:', typeof ort);

                ort.env.wasm.wasmPaths = ORT_CDN;
                ort.env.wasm.simd = true;
                ort.env.wasm.numThreads = 1;

                updateStatus('Loading ONNX model...', 'loading');

                const modelPath = '/models/tts/flow_lm_main_int8.onnx';
                console.log('Creating session for model:', modelPath);

                const opts = {
                    executionProviders: ['wasm'],
                    graphOptimizationLevel: 'all'
                };

                const session = await ort.InferenceSession.create(modelPath, opts);

                updateStatus('Model loaded successfully!', 'success');

                console.log('Session created successfully');
                console.log('Input names:', session.inputNames);
                console.log('Output names:', session.outputNames);

                // Display model information
                displayModelInfo(session);

                // Display all inputs
                displayInputs(session);

                // Display all outputs
                displayOutputs(session);

                // Find and display state inputs
                const stateInputs = displayStateInputs(session);

                // Generate code
                generateFixCode(stateInputs);

            } catch (err) {
                updateStatus(`Error: ${err.message}`, 'error');
                console.error('Full error:', err);
                console.error('Stack:', err.stack);
                document.getElementById('model-info').innerHTML =
                    `<pre style="color: red;">Error loading model:\n\n${err.message}\n\n${err.stack}</pre>`;
            }
        }

        function updateStatus(msg, state) {
            const el = document.getElementById('status');
            el.textContent = msg;
            el.className = `status ${state}`;
        }

        function displayModelInfo(session) {
            const info = `
Total Inputs: ${session.inputNames.length}
Total Outputs: ${session.outputNames.length}
            `.trim();
            document.getElementById('model-info').innerHTML = `<pre>${info}</pre>`;
        }

        function displayInputs(session) {
            let html = '';
            session.inputNames.forEach(name => {
                const metadata = session.inputMetadata[name];
                const isState = name.startsWith('state_');
                const className = isState ? 'input-row state-input' : 'input-row';
                html += `
<div class="${className}">
    <strong>${name}</strong>
    <br/>Shape: ${JSON.stringify(metadata.dims)}
    <br/>Type: ${metadata.type}
    <br/>Rank: ${metadata.dims.length}
</div>`;
            });
            document.getElementById('inputs').innerHTML = html;
        }

        function displayOutputs(session) {
            let html = '';
            session.outputNames.forEach(name => {
                const metadata = session.outputMetadata[name];
                const isState = name.startsWith('out_state_');
                const className = isState ? 'output-row state-input' : 'output-row';
                html += `
<div class="${className}">
    <strong>${name}</strong>
    <br/>Shape: ${JSON.stringify(metadata.dims)}
    <br/>Type: ${metadata.type}
    <br/>Rank: ${metadata.dims.length}
</div>`;
            });
            document.getElementById('outputs').innerHTML = html;
        }

        function displayStateInputs(session) {
            const stateInputs = {};
            let html = '';

            session.inputNames.forEach(name => {
                if (name.startsWith('state_')) {
                    const metadata = session.inputMetadata[name];
                    stateInputs[name] = metadata.dims;
                    html += `
<div class="state-input">
    <strong>${name}</strong>
    <br/>Shape: [${metadata.dims.join(', ')}]
    <br/>Type: ${metadata.type}
    <br/>Rank: ${metadata.dims.length}
    <br/>Total elements: ${metadata.dims.reduce((a, b) => a * b, 1)}
</div>`;
                }
            });

            document.getElementById('state-inputs').innerHTML = html;
            return stateInputs;
        }

        function generateFixCode(stateInputs) {
            // Generate the shape map
            let shapeMapCode = '// Shape map for each state input (from model inspection)\n';
            shapeMapCode += 'const stateShapeMap = {\n';

            Object.entries(stateInputs).forEach(([name, dims]) => {
                shapeMapCode += `    "${name}": [${dims.join(', ')}],\n`;
            });

            shapeMapCode += '};\n\n';

            // Generate initialization code
            let initCode = '// Initialize state with correct individual shapes\n';
            initCode += 'let flowState = {};\n';
            initCode += 'for (const stateName of stateInputNames) {\n';
            initCode += '    const stateShape = stateShapeMap[stateName];\n';
            initCode += '    const stateSize = stateShape.reduce((a, b) => a * b, 1);\n';
            initCode += '    flowState[stateName] = new ort.Tensor("float32", new Float32Array(stateSize).fill(0), stateShape);\n';
            initCode += '    console.log(`Initialized ${stateName} with shape [${stateShape.join(", ")}]`);\n';
            initCode += '}\n';

            const fullCode = shapeMapCode + initCode;
            document.getElementById('generated-code').textContent = fullCode;
        }

        // Run inspection
        inspectModel();
    </script>
</body>
</html>
