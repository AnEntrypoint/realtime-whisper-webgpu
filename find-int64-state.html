<!DOCTYPE html>
<html>
<head>
    <title>Find int64 State</title>
</head>
<body>
    <h1>Finding which state needs int64...</h1>
    <pre id="output" style="font-size: 11px; max-height: 800px; overflow: auto;"></pre>
    <script type="module">
        const ORT_VERSION = '1.20.0';
        const ORT_CDN = `https://cdn.jsdelivr.net/npm/onnxruntime-web@${ORT_VERSION}/dist/`;

        function log(msg) {
            console.log(msg);
            document.getElementById('output').textContent += msg + '\n';
        }

        async function test() {
            try {
                const ortModule = await import(ORT_CDN + 'ort.min.mjs');
                const ort = ortModule.default || ortModule;

                ort.env.wasm.wasmPaths = ORT_CDN;
                ort.env.wasm.simd = true;
                ort.env.wasm.numThreads = 1;

                const session = await ort.InferenceSession.create('/models/tts/flow_lm_main_int8.onnx', {
                    executionProviders: ['wasm'],
                    graphOptimizationLevel: 'all'
                });

                log('Testing each state as int64 to find the correct one...\n');

                // State shapes
                const shapes = {
                    'state_0': [2, 1, 1000, 16, 64],
                    'state_1': [0]
                };
                for (let i = 2; i <= 17; i++) {
                    shapes[`state_${i}`] = [1];
                }

                // Test each state
                for (let testIdx = 2; testIdx <= 17; testIdx++) {
                    const testStateName = `state_${testIdx}`;
                    log(`Testing ${testStateName} as int64...`);

                    const seqData = new Float32Array(1 * 1 * 32).fill(0);
                    const sequence = new ort.Tensor('float32', seqData, [1, 1, 32]);

                    const textData = new Float32Array(0);
                    const textEmb = new ort.Tensor('float32', textData, [1, 0, 1024]);

                    const stateInputs = {};

                    for (let i = 0; i <= 17; i++) {
                        const name = `state_${i}`;
                        const shape = shapes[name];
                        const size = shape.reduce((a, b) => a * b, 1);

                        if (size === 0) {
                            stateInputs[name] = new ort.Tensor('float32', new Float32Array(0), shape);
                        } else if (i === testIdx) {
                            // This state is int64
                            const data = new BigInt64Array(size).fill(BigInt(0));
                            stateInputs[name] = new ort.Tensor('int64', data, shape);
                        } else {
                            const data = new Float32Array(size).fill(0);
                            stateInputs[name] = new ort.Tensor('float32', data, shape);
                        }
                    }

                    try {
                        const inputs = {
                            sequence,
                            text_embeddings: textEmb,
                            ...stateInputs
                        };

                        const result = await session.run(inputs);
                        log(`  âœ“ SUCCESS! ${testStateName} is int64!`);
                        break;

                    } catch (err) {
                        const msg = err.message;
                        if (msg.includes('Unexpected input data type') && msg.includes('expected: (tensor(int64))')) {
                            // Still looking...
                            log(`    Still looking for int64 state...`);
                        } else if (msg.includes('Unexpected input data type') && msg.includes('expected: (tensor(float))')) {
                            // This one shouldn't be int64
                            log(`    No, ${testStateName} should be float32`);
                        } else {
                            // Different error
                            log(`    Different error: ${msg.substring(0, 80)}`);
                            break;
                        }
                    }
                }

            } catch (err) {
                log(`Error: ${err.message}`);
            }
        }

        test();
    </script>
</body>
</html>
